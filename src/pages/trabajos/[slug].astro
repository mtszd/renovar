---
import MainLayout from 'src/layouts/MainLayout.astro';
import LightboxGallery from '../../components/gallery/LightboxGallery.svelte';
import { getWorkBySlug, getAllWorks, type Work } from 'src/data/works.ts';

export function getStaticPaths() {
    const works = getAllWorks();
    return works.map(work => ({
        params: { slug: work.slug }
    }));
}

const { slug } = Astro.params;
const work = getWorkBySlug(slug);

if (!work) {
    return Astro.redirect('/404');
}

const [city, province] = work.location.includes(',') 
    ? work.location.split(', ') 
    : [work.location, ''];

interface LightboxGalleryProps {
    galleryId: string;
    slug: string;
    imageCount: number;
    'client:load': boolean;
}

const galleryProps: LightboxGalleryProps = {
    'client:load': true,
    galleryId: `gallery-${work.slug}`,
    slug: work.slug,
    imageCount: work.imageCount
};
---

<MainLayout title={work.title}>
    <main class="work-detail">
        <div class="top-content">
            <div class="info-column">
                <h1>{work.title}</h1>
                <p class="description">{work.description}</p>

                <div class="key-info-grid">
                    <div class="key-info-item">
                        <i class="fa-solid fa-location-dot"></i>
                        <span><strong>{city}</strong>{province && `, ${province}`}</span>
                    </div>
                    <div class="key-info-item">
                        <span class="badge">{work.type}</span>
                    </div>
                    <div class="key-info-item">
                        <i class="fa-solid fa-bolt"></i>
                        <strong>{work.technicalDetails.kw} kWp</strong>
                    </div>
                </div>

                <div class="details-columns-wrapper">
                    <div class="details-section">
                        <h2>Ficha Técnica</h2>
                        <div class="details-grid">
                            <div class="grid-card">
                                <h4>Sistema</h4>
                                <p>{work.technicalDetails.system}</p>
                            </div>
                            <div class="grid-card">
                                <h4>Inversores</h4>
                                <p>{work.technicalDetails.inverters}</p>
                            </div>
                            <div class="grid-card">
                                <h4>Paneles</h4>
                                <p>{work.technicalDetails.panelModel} ({work.technicalDetails.panels} u.)</p>
                            </div>
                            <div class="grid-card">
                                <h4>Producción Anual</h4>
                                <p>{work.performance.annualProduction ? `${work.performance.annualProduction.toLocaleString('de-DE')} kWh` : 'N/D'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h2>Impacto Ambiental</h2>
                        <div class="details-grid">
                            <div class="grid-card">
                                <h4><i class="fa-solid fa-cloud"></i> CO₂ Evitado</h4>
                                <p>{work.environmentalImpact.co2Avoided ? `${work.environmentalImpact.co2Avoided.toLocaleString('de-DE')} kg/año` : 'N/D'}</p>
                            </div>
                            <div class="grid-card">
                                <h4><i class="fa-solid fa-tree"></i> Equivalente</h4>
                                <p>{work.environmentalImpact.equivalentTrees ? `${work.environmentalImpact.equivalentTrees.toLocaleString('de-DE')} árboles` : 'N/D'}</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="video-column">
                {work.videoUrl ? (
                    <iframe 
                        src={work.videoUrl} 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                ) : (
                    <div class="video-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="play-icon">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="10 8 16 12 10 16 10 8"></polygon>
                        </svg>
                        <span>Próximamente</span>
                    </div>
                )}
            </div>
        </div>

        <div class="gallery-container">
            <LightboxGallery 
                client:load
                galleryId={`gallery-${work.slug}`}
                slug={work.slug}
                imageCount={work.imageCount}
            />
        </div>
    </main>
</MainLayout>

<style>
    .work-detail {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
        padding-top: 10rem;
        background-color:#fff;
    }

    .top-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1rem;
        margin-bottom: 10rem;
    }

    .info-column {
        max-width: 720px;
    }

    .info-column h1 {
        font-size: 2.25rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
    }

    .description {
        font-size: 1.05rem; /* Tamaño ajustado */
        color: #555;
        margin-bottom: 3rem;
        line-height: 2;
    }

    /* --- INICIO: ESTILOS REFINADOS --- */

    /* Fila de información clave (Ubicación, Cliente, Potencia) */
    .key-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2.5rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 12px;
    }

    .key-info-item {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.65rem;
        font-size: 0.9rem; /* Tamaño ajustado */
        padding: 0.5rem;
    }

    .key-info-item i {
        color: #007bff;
        font-size: 1.1rem;
    }

    .badge {
        display: inline-block;
        padding: 0.35em 0.8em;
        font-size: 0.85rem; /* Tamaño ajustado */
        font-weight: 600;
        line-height: 1;
        text-align: center;
        border-radius: 0.375rem;
        background-color: #e0e7ff;
        color: #3730a3;
    }

    /* Contenedor para las dos columnas de detalles */
    .details-columns-wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }
    
    .details-section {
        margin-bottom: 0; /* Se elimina el margen para que lo controle el wrapper */
    }

    /* Estilo para los títulos "Ficha Técnica" e "Impacto Ambiental" */
    .details-section h2 {
        font-size: 0.75rem; /* Requerimiento: Tamaño muy pequeño */
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 1rem;
        padding-bottom: 0;
        border-bottom: none; /* Sin borde */
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Grilla para tarjetas de datos */
    .details-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }

    .grid-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }

    .grid-card h4 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        margin: 0 0 0.25rem 0;
    }

    .grid-card p {
        font-size: 0.9rem; /* Tamaño ajustado */
        font-weight: 600;
        color: #212529;
        line-height: 1.2;
    }
    
    /* --- FIN: ESTILOS REFINADOS --- */
    
    .video-column, .gallery-container {
        width: 100%;
    }

    .video-placeholder {
        width: 100%;
        aspect-ratio: 16 / 9;
        background-color: #e9e9e9;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #aaa;
    }

    .video-placeholder .play-icon {
        stroke: #ccc;
        margin-bottom: 0.5rem;
    }
    
    .video-column iframe {
        width: 100%;
        aspect-ratio: 16 / 9;
        border: none;
        border-radius: 8px;
    }

    /* --- Media Queries para Responsividad --- */
    @media (max-width: 992px) {
        .top-content {
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        .video-column {
            order: -1; 
        }
    }

    @media (max-width: 768px) {
        .details-columns-wrapper {
            grid-template-columns: 1fr; /* Las secciones se apilan */
            gap: 2.5rem;
        }
    }

    @media (max-width: 576px) {
        .details-grid {
            grid-template-columns: 1fr; /* Las tarjetas se apilan */
        }
        .grid-card p {
            font-size: 1.25rem;
        }
    }
</style>